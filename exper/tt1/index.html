<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="../../assets/js/jquery.js"></script>
    <script src='../../assets/jsPsych/jspsych.js'></script>
    <script src='../../assets/jsPsych/plugins/jspsych-html-keyboard-response.js'></script>
    <script src='../../assets/jsPsych/plugins/jspsych-survey-text.js'></script>
    <script src='../../assets/jsPsych/plugins/jspsych-html-button-response.js'></script>
    <script src="../../assets/jsPsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="../../assets/jsPsych/plugins/jspsych-survey-html-form.js"></script>
    <script src="../../assets/jsPsych/plugins/jspsych-instructions.js"></script>
    <script src="../../assets/jsPsych/plugins/jspsych-fullscreen.js"></script>
    <link href="./jspsych.css" rel="stylesheet" type="text/css">
    <script src="../../assets/psychophysics/jspsych-psychophysics.js"></script>
    <script src="../../assets/js/jSignature/jSignature.min.js"></script>
    <style>
        .add_{
            font-size: 25px;
        }

        body {
            background-color: grey;

        }
        .zfx {
            margin: 0 20px;
        }
        #jspsych-html-keyboard-response-stimulus {
            width: 600px;
            /* 中间盒子宽度 */
            min-height: 500px;
            /*中间盒子最小高度*/
            display: flex;
            /*设置弹性盒布局ee*/
            flex-direction: column;
            /*设置弹性盒为纵向的布局*/
            align-items: center;
            /*垂直居中*/
            justify-content: space-around;
            /*弹性盒对象的 <div> 元素中的各项周围留有空白,并且是均分的,横向的*/
            position: relative;
            /*绝对定位 父元素相对定位*/
        }
        #aaa {
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 30px !important;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -15px;
            margin-top: -15px;

        }
        .flex_body {
            display: flex;
            justify-content: center;
        }

    </style>
    <title>测试版本</title>
</head>
<body style="text-align:center;">
</body>
<script>
    let size_proportion = (window.screen.height / 900) - 0.1;
    // 0.1 消除 滚动框
    let debug_round = 6;
    let acc = 0.6;// 60进入正式实验
    let exper_number = "v01";
    // debug版本 正式版 上面数值为 6 0.6
    // debug版本 正式版 需要修改 965




    let img = ["img/C.bmp", "img/S.bmp", "img/T.bmp"];
    let word = ["好人", "坏人", "常人"];
    let aaaaa = 0; // 0 为练习，1为正式一，以此类推

    let b = []; //stimulate null
    // let i1 = jsPsych.randomization.sampleWithoutReplacement(img, 3);
    // 1
    let block_name = "prac";
    let i1 = [], sti = [];
    let answer = jsPsych.randomization.sampleWithoutReplacement(["m", "n"], 2);
    i1 = [img[0], img[1], img[2]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    });
    sti.push(b);
    b = [];
    // 2
    i1 = [img[0], img[2], img[1]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    });
    sti.push(b);
    b = [];
    // 3
    i1 = [img[1], img[0], img[2]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    });
    sti.push(b);
    b = [];
    // 4
    i1 = [img[1], img[2], img[0]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    });
    sti.push(b);
    b = [];
    // 5
    i1 = [img[2], img[1], img[0]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    });
    sti.push(b);
    b = [];
    // 6
    i1 = [img[2], img[0], img[1]];
    b.push({
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[0],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[0],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[1],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[1],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[0],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[1],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[1]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    }, {
        stimulus: i1[2],
        item: word[2],
        data: {
            test_part: "test",
            correct_response: answer[0]
        }
    });
    sti.push(b);
    b = [];
    console.log(sti);

    let round_all = 0;


    // console.log(b);
    // sti 0 - 5
    let k = Math.floor(Math.random() * 6);  // 分组 组别  6 % 6 = 0
    let test_stimuli = jsPsych.randomization.sampleWithoutReplacement(sti[k], sti[k].length);

    let timeline = [];


    let error1 = {
        type: "html-keyboard-response",
        stimulus: "<p style='color:white ;font-size : 25px'>错误次数过多，请按任意键重新进行实验～</p>",
        choices: jsPsych.ALL_KEYS
        // 判断是否错误过多
    };



    let enterFullscreenMode = {
        type: "fullscreen",
        fullscreen_mode: true,
        message: "<p style = 'color : white'>实验需要全屏模式</p>",
        button_label: "点击这里进入全屏"
    }; // 全屏指导



    let welcome = {
        type: "html-keyboard-response",
        stimulus:
            "<p style='font: bold 42px 华文楷体; color: #adff87'>\
           欢迎参与我们的实验</p>\
           <p style='font：30px S华文楷体; color: white'><br/>\
           <按任意键继续><br/><b>实验过程中请勿退出全屏</b>\
           <br/><br/></p>\
           <p style='font:24px 华文楷体; color: grey'>\
           <br/>2021年</p>",
        post_trial_gap: 100,
        data: {
            sti_group: k,
            sti_match: answer[0],
            sti_mismatch: answer[1],
            save: true
        }
    };

    let ss = "   \
            .title{ \
                font-size: " + 30 * size_proportion + "px;\
                text-align: center;\
                font-weight: 700;\
            }\
            .para{ \
                font-size: " + 20 * size_proportion + "px; \
                text-indent: 2em; \
                text-align: left; \
                margin-block: " + 10 * size_proportion + "px; \
            }\
            .foot{ \
                text-align: right;\
                font-size: " + 20 * size_proportion + "px;\
            }";
    let sign;
    let instr = {
        type: "instructions",
        pages: [
            "<div class='contacts'>   <p class='title' style='color:#fff'>实验内容介绍</p> <div style='color: white;'class='content_box'>\
                <style>" + ss + "\
            </style>    \
           \
            <p class='para'>您好，欢迎参加本次实验。为充分保障您的权利，在以下关于实验的介绍结束后，您看到两份知情同意书。一份表示您已经了解本研究的内容及潜在风险；另一份表示您同意本研究的数据共享计划。如果您选择继续实验，则表示您已经清楚两份知情同意书的内容并同意。</p>\
            <p class='para'>实验说明：</p>\
            <p class='para'>您好，欢迎参加本次实验。</p>\
            <p class='para'>1. 您将学习几何图形与不同人物标签的对应关系。其中几何图形包括正方形、圆、三角形；标签包括：好人、常人和坏人。其中，</p>\
            <p class='para' style='text-indent: 4em;'>好人代表的是一个道德高尚的人；</p>\
            <p class='para' style='text-indent: 4em;'>坏人代表的是一个道德败坏的人；</p>\
            <p class='para' style='text-indent: 4em;'>常人代表的是一个道德上普遍的人；</p>\
            <p class='para'>图形与人物标签的具体对应关系会在实验开始前呈现，您记住了图形与人物标签的对应关系之后，按空格键进入到实验部分。</p>\
            <p class='para'>2. 练习部分与实验任务。</p>\
            <p class='para'>本次实验中，您需要完成一个匹配任务。</p>\
            <p class='para'>本次实验中，屏幕中央会再现“+”，“+”上方面会现在几何图形中的一个，下方会出现人物标签中的一个，您的任务是判断几何图形与人物标签是否与您学习到的关系相匹配；匹配按一个键，不匹配按另一个键。</p>\
            <p class='para'>完成匹配任务的练习之后，您将完成6组匹配任务，每组包括72次按键反应，中途至少有10秒的休息。完成一组任务大约需要3分钟，整个实验将持续大约24分钟。\n</p>\
            <p class='para'>3. 如果对本实验有不清楚之处，请向实验员咨询。</p>\
            </div> </div>",
            "<div class='contacts'><p class='title' style='color:#fff'>参与实验知情同意书</p> <div style='color: white;' class='content_box'>\
                <style>" + ss + "\
            </style>    \
                \
            <p class='para'><strong>调查目的：</strong>本次实验的目的是了解社会信息学习对知觉匹配过程的影响。 </p>\
            <p class='para'><strong>您需要做什么：</strong>本实验包括两部分。第一部分，是按键反应的实验，这个阶段，您将学习一系列几何图形与其他信息的联结关系。记住这种联结关系之后，您需要完成图形－文字匹配任务，具体任务说明见指导语部分。第二部分，您需要完成一系列问卷。 </p>\
            <p class='para'><strong>所需时间：</strong>本实验需要大约24分钟。 </p>\
            <p class='para'><strong>风险：</strong>参加本次实验没有任何可预见的风险，但可能由于实验任务而感到疲劳或者无聊。 </p>\
            <p class='para'><strong>收益：</strong>您在本实验中主要收益是您对于科学研究的贡献！同时，为了补偿您参加研究中的时间，我们给予您一定的经济补偿（￥<span style='color: red;'>XX</span>）。该经济补偿将由<span style='color: red;'>XXX</span>）。</p>\
            <p class='para'><strong>隐私：</strong>您在本次调查中给出的所有有信息将完全保密。您的信息将将会被编码、您的名字也不会在任何报告中出现。调查结束后，去除所有个人信息的数据将会公布出来，用于其他研究来使用和评估。</p>\
            <p class='para'><strong>自愿参与：</strong>您对本次调查的参与完全是自愿的。 </p>\
            <p class='para'><strong>退出调查的权利：</strong>您有权在调查中的任何阶段退出本次调查，不会有任何的惩罚，我们会根据完成实验的时间，补偿您在本实验室所费时间。</p>\
            <p class='para'><strong>如何退出：</strong>如果您决定退出本次调查，请告知实验员，我们会立即终止实验。 如果您有任何疑问，请联系：胡传鹏博士（南京师范大学心理学院，江苏省南京市鼓楼区宁海路122号，210024；Email: hcp4715@hotmail.com；Tel: 15910258380） </p>\
            <p class='para'><strong>同意书：</strong>我同意参与上述的调查，并通过点击“继续”按键表示我同意参与本实验。 </p>\
            <p class='para foot'>南京师范大学心理学院•计算社会认知实验室</p>\
            </div> </div>",
            "<div class='contacts'> <p class='title' style='color:#fff'>公开数据知情同意书</p> <div style='color: white;' class='content_box'>\
                <style>" + ss + "\
            </style>    \
           \
            <p class='para'>本次研究的费用来自于政府的科研资助，也就是来自于纳税人<strong>公共资金</strong>，而本次实验的数据提供者是您本人，所以本次实验的实验数据的直接所有者是您本人。将本研究的数据公开、且能为其他研究者使用，将会更大程度上地充分利用公共资金（例如，其他研究者可能不需要再次收集类似的数据），从而将您对科研界及人类社会的贡献最大化。但数据公开需要获得您的直接同意。\
            <p class='para'>公开本实验的数据，意味着您在本研究中所提供的数据未来可能会被其他研究项目使用。未来这些项目也许会与本研究的问题相关，也有可能无关。我们使用网络存储的公开数据库，将本次研究中的数据完全公开。\
            <p class='para'>共享的数据中不会出现您的姓名，而仅以代号显示，所以他人不会获知您的姓名，也无法将数据与您进行对应。此外，我们也将对其他敏感信息进行保密，避免了解您的人通过某些信息猜测到哪些是您的数据。\
            <p class='para'>如果您改变主意并想将此同意书撤回（您可以通过拨打『+8615910258380』致电『胡传鹏博士』来执行此操作），我们将不会录入关于您的任何额外数据。如果您在数据被录入数据库之前申请撤回，您的数据将能够被及时删除。请注意，所有已经公开共享给其他研究者或公开的数据和研究结果已经被匿名处理，无法再进行销毁或撤回。\
            <p class='para'>同意参与本研究，意味着您的数据将可能会在其他研究中被重复使用，这些研究可能会让人类社会变得更好。还有可能的是，使用您所共享数据的研究会有助于开发出新的诊断量表、新药物或其他产出。但是如果出现这些情况，您本人不会从这些产品中获得任何利益，也不会获得这些产品的任何所有权。\
            <p class='para'>根据我们充分了解到的情况，我们向公众共享的数据中将不会包含能够直接识别出您身份的信息。数据中没有您的名字、只有编码的数字，因此他人不会知道您的名字或者知道哪个数据是您。此外，数据中不会包括我们认为可能会让了解您的人猜测到哪个数据属于您的信息，比如您参与研究的日期等。如果我们就本研究撰写报告、文章，或者将本次研究的数据分享给他人，我们也将确保您不会被识别出来\
            <p class='para'>然而，非法的安全破坏（比如，网络入侵或网络攻击）可能会导致他人从数据中识别您的身份。但是，这种风险很低，因为我们会将您的数据储存在安全的数据库；并且，您的身份信息与数据是分开存储的，只有一个代码可以将二者联系起来。\
            <p class='para'>您数据的隐私部分（包括姓名，联系方式等）将至少被安全保存10年。在该期限后，我们将会销毁这些信息以保护您的隐私。\
            <p class='para'>是否让我们使用及分享您的数据将完全由您自愿决定。但是，参加本研究的前提是您愿意使用这种方式来分享您的数据。如果您不愿意，您将无法参加这项研究。\
            <p class='para'>如果您在下方签名，代表您同意向未来的研究共享您的数据，同意与来自世界各地研究机构的研究者共享您的数据。这些未来研究的细节、结果和应用均是未知的。\
            </div> </div>"
        ],
        show_clickable_nav: true,
        allow_backward: true,
        button_label_previous: "返回",
        button_label_next: "继续"
    };
    timeline.push(enterFullscreenMode,  welcome, instr); // 开头，数据收集
    let subject_number = "";
    let experinumber = {
        type:"survey-html-form",
        data:{
            varname:'subjectnumber',
        },
        preamble:"<p style =' color : white'>你分配到的实验编号是</p>",
        html:"<p><input name='Q0' type='text' value='" + exper_number + "' disabled='disabled' /></p><p><input name='Q1' type='number' value='0001' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1;
            data.save = true;
            let pp = JSON.parse(data.responses);
            data.number = exper_number + pp.Q1.padStart(4, "0");
            subject_number = exper_number + pp.Q1.padStart(4, "0");
        },
        on_load: function () { 
            let bb = document.getElementById("jspsych-content");
            let label1 = document.createElement("p");
            label1.id = "numberf", label1.textContent = "你的最终编号是：" + document.getElementsByTagName("input")[0].value + document.getElementsByTagName("input")[1].value.toString().padStart(4, "0");
            label1.style = "font-size: 20px;color: white;";
            bb.appendChild(label1);
            document.getElementsByTagName("input")[1].addEventListener("input", function(a){
                document.getElementById("numberf").textContent = "你的最终编号是：" + document.getElementsByTagName("input")[0].value + document.getElementsByTagName("input")[1].value.toString().padStart(4, "0");
            })
        }
    };
    let number_of_experiment ={
        type:"survey-html-form",
        data:{
            varname:'number_of_experiment',
            save: true
        },

        preamble:"<p style = 'color : white'>你的实验次数是</p>",
        html:"<p><input name='Q0' type='number' value=' ' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1
        }

    };
    let person_name = {
        type:"survey-html-form",
        data:{
            varname:'name',
        },
        preamble:"<p style =' color : white'>你的名字是</p>",
        html:"<p><input name='Q0' type='text' value='' required/></p>",
        button_label:"继续",
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1;
            data.save = true;
        }
    };
    let sex = {
        type: 'html-button-response',
        data: {
            varname: 'sex'
        },
        stimulus: "<p style = 'color : white'>你的性别</p>",
        choices: ['男', '女', '其他'],
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1;
            data.save = true;
        }
    };
    let birth = {
        type: 'survey-html-form',
        data: {
            varname: 'birth'
        },
        preamble: "<p style = 'color : white'>你的出生年</p>",
        html: `
    <p><input name="Q0" type="number" placeholder="1900~2020" min=1900 max=2020
    oninput="if(value.length>4) value=value.slice(0,4)" required /></p>`,
        button_label: '继续',
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1;
            data.save = true;
        }
    };
    let education = {
        type: 'survey-html-form',
        data: {
            varname: 'education'
        },
        preamble: "<p style = 'color : white'>教育经历</p>",
        html: `
       <p><select name="Q0" size=10>
       <option>小学以下</option>
       <option>小学</option>
       <option>初中</option>
       <option>高中</option>
       <option>大学</option>
       <option>硕士</option>
       <option>博士</option>
       <option>其他</option>
       </select></p>`,
        button_label: '继续',
        on_finish: function addRespFromSurvey(data) {
            data.response = parseInt(data.button_pressed) + 1;
            let bodyNode = document.getElementsByTagName("body");
            for (let i = 0; i < bodyNode.length; i++) {
                bodyNode[i].style.cursor = "none";}
            data.save = true;

        }
    };
    timeline.push(experinumber, number_of_experiment, person_name, sex, birth, education, {
        type: "html-keyboard-response",
        stimulus: "<p style ='font-size:25px; color:white'>为了保证实验中按键准确，请您按键盘上M键</p>",
        choices: ["m"]
    }, {
        type: "html-keyboard-response",
        stimulus: "<p style ='font-size:25px; color:white'>为了保证实验中按键准确，请您按键盘上N键</p>",
        choices: ["n"]
    }); // 信息收集


    let instructions1 = {
        type: "html-keyboard-response",
        stimulus: "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>请您记住如下联结:</p>" +
            "<p style= 'text-align: center; font-weight:700; font-size:35px; color : white'>" + sti[k][0].item + "---" + (sti[k][0].stimulus.indexOf("C")!==-1 ? "圆形" : (sti[k][0].stimulus.indexOf("S")!==-1 ? "正方形" : "三角形")) + "</p>" +
            "<p style= 'text-align: center; font-weight:700; font-size:35px; color : white'>" + sti[k][5].item + "---" + (sti[k][5].stimulus.indexOf("C")!==-1 ? "圆形" : (sti[k][5].stimulus.indexOf("S")!==-1 ? "正方形" : "三角形")) + "</p>"+
            "<p style= 'text-align: center; font-weight:700; font-size:35px; color : white'>" + sti[k][11].item + "---" + (sti[k][11].stimulus.indexOf("C")!==-1 ? "圆形" : (sti[k][11].stimulus.indexOf("S")!==-1 ? "正方形" : "三角形")) + "</p>" +
            "<p style= 'text-align: center; font-weight:700; font-size:25px; color : white'>您需要通过练习来学习这些对应关系；接下来，如果屏幕上出现的图形和文字符合上述关系，请按“"+answer[0]+"”键；如果图形与文字不符合上述的关系，请按“"+answer[1]+"”键。请您又快又准地进行反应</p>"+
            "<p style = 'color : lightgreen; font-size:25px'>按任意键开始实验</p><div>",
        post_trial_gap: 2000
    };

    let feedback_trial = {
        data: {
            screen_id: "feedback"
        },
        type: "html-keyboard-response",
        stimulus: function () {
            let key = jsPsych.data.get().last(1).values()[0].key_press;
            let last_trial_accuracy = jsPsych.data.get().last(1).values()[0].correct;
            // let time = jsPsych.data.get().last(1).values()[0].rt;
            if (last_trial_accuracy && key) {
                return "<span class='add_' style='color: #adff87;'> correct! </span>"
            } else if (!key) {
                return "<span class='add_' style='color: yellow;'> Too slow! </span>"
            } else {
                return "<span class='add_' style='color: red;'> incorrect! </span>"
            }
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: 300
    };

    let plus1 = {
        type: "psychophysics",
        stimuli: [
            {
                obj_type: 'cross',
                startX: "center", // location of the cross's center in the canvas
                startY: "center",
                line_length: 30 * size_proportion,
                line_width:5 * size_proportion,
                line_color: 'black', // You can use the HTML color name instead of the HEX color.
                show_start_time: 500,
                show_end_time: 1100// ms after the start of the trial

            },
            {
                obj_type: 'image',
                file: jsPsych.timelineVariable("stimulus"),
                startX: "center", // location of the cross's center in the canvas
                startY: 320 * size_proportion,
                show_start_time: 1000, // ms after the start of the trial
                show_end_time: 1100,
                scale: size_proportion
            },
            {
                obj_type: 'text',
                startX: "center",
                startY: 550 * size_proportion,
                content: jsPsych.timelineVariable("item"),
                font: (50*size_proportion).toString() + "px 'Arial'",
                text_color: 'white',
                show_start_time: 1000, // ms after the start of the trial
                show_end_time: 1100
            }
        ],
        choices: [answer[0], answer[1]],
        canvas_height:900 * size_proportion,
        response_start_time: 1000,
        data: function () {
            round_all += 1;
            let t = jsPsych.timelineVariable("stimulus", true);
            let w = jsPsych.timelineVariable("item", true);
            let key = jsPsych.timelineVariable("data", true);
            return {
                shape: t,//刺激类型
                shape_en: (t.indexOf("C")!==-1 ? "circular" : (t.indexOf("S")!==-1 ? "square" : "triangle")),
                word: w,//words
                key: key.correct_response,
                test_part: key.test_part + frequency,
                save: true,
                trial: aaaaa,
                time_stamp: Date.now(),
                label: w,
                label_en: (w === "好人") ? "good" : ((w === "坏人") ? "bad" : "ordinary"),
                block: block_name + "_" + aaaaa.toString(),
                block_id: aaaaa.toString(), // block 出现的顺序
                trial_id: (round_all - 1) % 12 + 1, // 每个block里试次出现的顺序
                block_type: block_name, // prac test 练习还是正式实验
                trial_type_num: (round_all % 12) ? parseInt(round_all/12) + 1 : parseInt(round_all/12), //记录试次循环
            }
        },
        on_finish: function (data) {
            data.correct = data.key === jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press);
        },
        trial_duration: 2200,
        background_color: "grey"
    };

    let frequency = 0;
    let trial1 = {
        timeline: [
            plus1,
            feedback_trial
        ],
        timeline_variables: test_stimuli,
        randomize_order: true,
        loop_function: function () {
            let accuracy = jsPsych.data.get().filter({correct: true, test_part: "test" + (frequency)}).count() / jsPsych.data.get().filter({test_part: "test" + (frequency)}).count();
            console.log(accuracy);
            frequency += 1;
            if (accuracy >= acc && frequency<=1) {
                return true;
            } else if (accuracy >= acc) {
                let feedback_all_block = {
                    type: "html-keyboard-response",
                    stimulus: function () {
                        // aaaaa = 1;
                        frequency -= 1;
                        let trials = jsPsych.data.get().filter({
                            block: 'test_' + aaaaa.toString()
                        });
                        let correct_trials = trials.filter({
                            correct: true
                        });
                        let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
                        let rt = Math.round(correct_trials.select('rt').mean());
                        frequency += 1;
                        return "<style>.context{color:white; font-size: 30px;}</style>\
                            <div><p class='context'>你正确回答了" + accuracy + "% 的试次。</p>" +
                            "<p class='context'>你的平均反应时为" + rt + "毫秒。</p>" +
                            "<p class='context'>请按任意键继续实验!</p></div>";
                    }
                }; // 练习结束反馈阶段
                jsPsych.pauseExperiment();
                jsPsych.addNodeToEndOfTimeline({
                    timeline: [feedback_all, rest, trial2, feedback_all_block, rest1, trial2, feedback_all_block, rest1, trial2, feedback_all_block, rest1, trial2, feedback_all_block, rest1, trial2, feedback_all_block, rest1, trial2, feedback_all_block]
                }, jsPsych.resumeExperiment);
            } else {
                aaaaa = 0;
                jsPsych.pauseExperiment();
                jsPsych.addNodeToEndOfTimeline({
                    timeline: [feedback_all, error1,instructions1, trial1]
                }, function(){ jsPsych.resumeExperiment(); aaaaa += 1; });
            }
        }
    };
    timeline.push(instructions1, trial1); // 练习阶段

    let feedback_all = {
        type: "html-keyboard-response",
        stimulus: function () {
            // aaaaa = 1;
            frequency -= 1;
            let trials = jsPsych.data.get().filter({
                test_part: 'test' + frequency
            });
            let correct_trials = trials.filter({
                correct: true
            });
            let accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            let rt = Math.round(correct_trials.select('rt').mean());
            frequency += 1;
            return "<p style = 'color:white'>你正确回答了" + accuracy + "% 的试次。</p>" +
                "<p style = 'color:white'>你的平均反应时为" + rt + "毫秒。</p>" +
                "<p style = 'color:white'>请按任意键进入正式实验!</p>";
        }
    }; // 练习结束反馈阶段

    let rest = {
        type: "html-keyboard-response",
        stimulus: "<p style = 'color : white; font-size : 30px'>按任意键开始正式实验</p>",
        on_finish: function(){ aaaaa =1; block_name = "test"; round_all=0; },
        post_trial_gap:2000

    }; // 休息阶段
    let rest1 = {
        timeline: [
            {
                type: "html-keyboard-response",
                trial_duration: 10000, // 休息时间
                stimulus: "<p style = 'color: white; font-size : 30px' >休息一下<span id='iii'>10</span>秒</p>",
                on_load: function() {
                    aaaaa += 1;
                    let reduce = function () {
                        if (document.getElementById("iii").innerText > 1) {
                            document.getElementById("iii").innerText = (parseInt(document.getElementById("iii").innerText) - 1).toString();
                            setTimeout(reduce, 1000);
                        }
                    };
                    reduce();
                },
                choices: jsPsych.NO_KEYS
            },
            {
                type: "html-keyboard-response",
                stimulus: "<p style = 'color : white; font-size : 30px'>休息结束，请按 m 或 n 键开始实验</p><p style = 'color:yellow'>请保证您的手指轻放在 m和n 键上 以随时准备实验</p>",
                choices: jsPsych.ALL_KEYS
            }
        ]
    };
    let trial2 = {
        timeline: [plus1,feedback_trial],
        timeline_variables: test_stimuli,
        randomize_order: true,
        repetitions: debug_round
    };//正式实验

    jsPsych.init({
        timeline: timeline,
        preload_images: img,
        on_finish: function () {
            document.getElementById("jspsych-content").innerHTML = "<div><p style = 'color:white; font-size = 20px'>实验结束，非常感谢您的参与！</p >" +
                "<p style = 'color:white; font-size : 20px'>如果您对实验结果感兴趣，可以发邮件与我联系。</p >" +
                "<p style = 'color:white; font-size : 20px'>郑元瑞（Email: aaronzheng87@gmail.com） </p ></div>";
            jsPsych.data.get().filter({save: true}).localSave('csv', subject_number + '.csv');
            document.exitFullscreen();
            let bodyNode = document.getElementsByTagName("body");
            for (let i = 0; i < bodyNode.length; i++) {
                bodyNode[i].style.cursor = "default";
                setTimeout(function(){
                    window.close();
                },5000)

            }
        }
    })

</script>
</html>